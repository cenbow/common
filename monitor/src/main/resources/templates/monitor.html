<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <meta charset="UTF-8"/>
    <title>监控平台</title>

    <link href="css/font-awesome.min.css" rel="stylesheet"/>
    <link href="css/bootstrap.min.css" rel="stylesheet"/>

    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/echarts.common.min.js"></script>
    <script src="js/chart.js"></script>

    <style>
        .chart {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#"><i class="fa fa-line-chart fa-1x fa-fw"></i>监控平台</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-6" th:each="chart : ${charts}">
            <div class="panel panel-default" >
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-server fa-fw"></i> <span th:text="${chart}"/>
                    </h3>
                </div>
                <div class="panel-body">
                    <div th:id="${chart}" class="chart"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" th:inline="javascript">
    var chartMap = new Map();
    $(".panel-body div").each(function(){
        var chart = echarts.init($(this).get(0));
        chartMap.set($(this).attr('id'),chart);
        chart.setOption(default_option, true);
        chart.showLoading();
    });

    if ('WebSocket' in window) {
        var host = [[${#httpServletRequest.getServerName()+":"+#httpServletRequest.getServerPort()}]];
        websocket = new WebSocket("ws://"+host+"/chart_ws");
    } else {
        alert('Sorry, websocket not supported by your browser.');
    }

    websocket.onopen = function (event) {
        $(".panel-body div").each(function(){
            var id = $(this).attr('id');
            if(id != undefined) {
                websocket.send($(this).attr('id'));
            }
        });
    }

    websocket.onmessage = function (event) {

        var data = $.parseJSON(event.data);
        var name = data.name;
        var size = Object.keys(data.data).length;
        var legend = new Array(size);
        var series = new Array(size);

        $.each(data.data, function (key, value) {
            legend.push(key);
            series.push({
                name: key,
                type: 'line',
                showSymbol: false,
                hoverAnimation: false,
                areaStyle: {normal: {}},
                data: value
            });
        });

        var option = {
            legend: {
                data: legend
            },
            xAxis: {
                data: data.date
            },
            series: series
        };
        chartMap.get(name).hideLoading();
        chartMap.get(name).setOption(option);
    }

</script>

</html>